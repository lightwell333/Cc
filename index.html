<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Psyforge Psychedelic Fun</title>
<style>
  html,body{
    height:100%; margin:0; overflow:hidden;
    font-family:"Luckiest Guy","Comic Sans MS",cursive,system-ui,sans-serif;
    color:#fff; background:#000;
  }

  /* Background image */
  .bg{
    position:fixed; inset:0; z-index:0;
    background-image: url("https://i.imgur.com/Tz3AOMI.jpeg");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  /* Title overlay */
  .portal{
    position:fixed; inset:0; z-index:9999;
    display:grid; place-items:center; padding:24px;
  }
  .card{
    text-align:center; background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.18);
    border-radius:16px; padding:clamp(14px,3vw,32px);
    backdrop-filter:blur(8px) saturate(120%);
    box-shadow:0 16px 60px rgba(0,0,0,.45),
               inset 0 0 0 1px rgba(255,255,255,.06);
  }

  /* ENTER button */
  .enter{
    appearance:none; border:0; cursor:pointer; font-weight:900; letter-spacing:.6px;
    font-size:clamp(18px,3.2vw,28px);
    padding:.9em 2.2em; border-radius:999px; color:#031b1a;
    background:linear-gradient(45deg,#ff00ff,#00ffff,#ff9900,#7dffb3);
    background-size:300% 300%;
    animation:btnShift 6s ease infinite, btnPulse 1.8s ease-in-out infinite;
    box-shadow:0 12px 32px rgba(0,0,0,.35),
               0 0 0 3px rgba(255,255,255,.15) inset;
  }
  @keyframes btnShift{
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
  }
  @keyframes btnPulse{
    0%,100%{transform:scale(1)}
    50%{transform:scale(1.04)}
  }

  /* Fade when hiding overlay */
  .portal.hide{animation:fade .35s ease forwards}
  @keyframes fade{to{opacity:0; transform:scale(.98)}}

  /* Reappear button */
  .re{
    position:fixed; left:10px; bottom:10px; z-index:10000;
    font-size:11px; padding:4px 7px; border-radius:7px;
    background:rgba(0,0,0,.55); color:#dffcff;
    border:1px solid rgba(255,255,255,.65);
    cursor:pointer; opacity:.65;
  }
  .re:hover{opacity:1}
</style>
</head>
<body>

<!-- ===== TITLE OVERLAY ===== -->
<div class="bg"></div>

<section class="portal" id="portal">
  <div class="card">
    <button class="enter" id="enterBtn">ENTER</button>
  </div>
</section>

<button class="re" id="reBtn" title="Reappear">re</button>
<!-- ===== END TITLE OVERLAY ===== -->

<!-- ===== YOUR KALEIDOSCOPE CODE GOES BELOW ===== -->
<!-- Example placeholder -->
<canvas id="kaleidoCanvas"></canvas>
<!-- Replace with your real kaleidoscope HTML/JS -->
<!-- ============================================= -->

<script>
  const portal = document.getElementById('portal');
  const enter = document.getElementById('enterBtn');
  const reBtn = document.getElementById('reBtn');

  enter.addEventListener('click',(e)=>{
    e.preventDefault();
    portal.classList.add('hide');
    setTimeout(()=> portal.style.display='none',350);
  });

  reBtn.addEventListener('click',()=>{
    portal.style.display='grid';
    requestAnimationFrame(()=> portal.classList.remove('hide'));
  });
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Psyforge Psychedelic Fun</title>
<style>
  html,body{
    height:100%; margin:0; overflow:hidden;
    font-family:"Luckiest Guy","Comic Sans MS",cursive,system-ui,sans-serif;
    color:#fff; background:#000;
  }

  /* Background image */
  .bg{
    position:fixed; inset:0; z-index:0;
    background-image: url("https://i.imgur.com/Tz3AOMI.jpeg");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  /* Title overlay */
  .portal{
    position:fixed; inset:0; z-index:9999;
    display:grid; place-items:center; padding:24px;
  }
  .card{
    text-align:center; background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.18);
    border-radius:16px; padding:clamp(14px,3vw,32px);
    backdrop-filter:blur(8px) saturate(120%);
    box-shadow:0 16px 60px rgba(0,0,0,.45),
               inset 0 0 0 1px rgba(255,255,255,.06);
  }

  /* ENTER button */
  .enter{
    appearance:none; border:0; cursor:pointer; font-weight:900; letter-spacing:.6px;
    font-size:clamp(18px,3.2vw,28px);
    padding:.9em 2.2em; border-radius:999px; color:#031b1a;
    background:linear-gradient(45deg,#ff00ff,#00ffff,#ff9900,#7dffb3);
    background-size:300% 300%;
    animation:btnShift 6s ease infinite, btnPulse 1.8s ease-in-out infinite;
    box-shadow:0 12px 32px rgba(0,0,0,.35),
               0 0 0 3px rgba(255,255,255,.15) inset;
  }
  @keyframes btnShift{
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
  }
  @keyframes btnPulse{
    0%,100%{transform:scale(1)}
    50%{transform:scale(1.04)}
  }

  /* Fade when hiding overlay */
  .portal.hide{animation:fade .35s ease forwards}
  @keyframes fade{to{opacity:0; transform:scale(.98)}}

  /* Reappear button */
  .re{
    position:fixed; left:10px; bottom:10px; z-index:10000;
    font-size:11px; padding:4px 7px; border-radius:7px;
    background:rgba(0,0,0,.55); color:#dffcff;
    border:1px solid rgba(255,255,255,.65);
    cursor:pointer; opacity:.65;
  }
  .re:hover{opacity:1}
</style>
</head>
<body>

<!-- ===== TITLE OVERLAY ===== -->
<div class="bg"></div>

<section class="portal" id="portal">
  <div class="card">
    <button class="enter" id="enterBtn">ENTER</button>
  </div>
</section>

<button class="re" id="reBtn" title="Reappear">re</button>
<!-- ===== END TITLE OVERLAY ===== -->

<!-- ===== YOUR KALEIDOSCOPE CODE GOES BELOW ===== -->
<!-- Example placeholder -->
<canvas id="kaleidoCanvas"></canvas>
<!-- Replace with your real kaleidoscope HTML/JS -->
<!-- ============================================= -->

<script>
  const portal = document.getElementById('portal');
  const enter = document.getElementById('enterBtn');
  const reBtn = document.getElementById('reBtn');

  enter.addEventListener('click',(e)=>{
    e.preventDefault();
    portal.classList.add('hide');
    setTimeout(()=> portal.style.display='none',350);
  });

  reBtn.addEventListener('click',()=>{
    portal.style.display='grid';
    requestAnimationFrame(()=> portal.classList.remove('hide'));
  });
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>PsyForge Kaleidoscope — Touch Safe + Working Record</title>
<style>
  :root{
    --fg:#eafff4; --muted:#9fd0c0; --line:#0f1a18;
    --pill:#07120e; --glow:#35ff9a; --glow2:#7bffc8;
    --rad:12px; --gap:8px;
    --sideW: 260px; --edgeH: 84px;
    --pad: max(10px, env(safe-area-inset-left,0px));
    --padR:max(10px, env(safe-area-inset-right,0px));
    --padT:max(10px, env(safe-area-inset-top,0px));
    --padB:max(10px, env(safe-area-inset-bottom,0px));
  }
  /* Page hard-lock (no scroll/zoom fighting your gestures) */
  html,body{
    margin:0; height:100%; width:100%;
    position:fixed; inset:0;
    overflow:hidden; overscroll-behavior:none; touch-action:none;
    background:#000; color:var(--fg);
    font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
  }
  /* Center canvas */
  #stage{
    position:fixed; inset:0; z-index:0;
    width:100vw; height:100vh; display:block; background:#000; cursor:grab;
    touch-action:none;
  }
  /* Edge micro-docks */
  .pill{
    background:var(--pill); color:var(--fg); border:1px solid var(--line);
    border-radius:999px; padding:10px; font-size:18px; cursor:pointer;
    box-shadow:0 0 10px var(--glow), 0 0 20px var(--glow2);
    touch-action:manipulation;
  }
  .mini{
    background:linear-gradient(180deg,#081411,#0a1714);
    border:1px solid var(--line); border-radius:var(--rad);
    box-shadow:0 0 0 1px #0a1714, 0 0 18px rgba(53,255,154,.18);
    padding:10px; color:var(--fg); font-size:13px;
  }
  label{display:grid; gap:4px; font-size:12px; color:var(--muted)}
  input[type=range], input[type=file], button{ touch-action:manipulation; }
  input[type=range]{width:140px}
  /* TOP */
  .dockTop{position:fixed; z-index:10; left:50%; transform:translateX(-50%); top:var(--padT)}
  .topPanel{position:absolute; left:50%; transform:translate(-50%,8px); top:42px; width:min(96vw,560px); height:var(--edgeH); display:none}
  .dockTop.open .topPanel{display:block}
  /* BOTTOM */
  .dockBottom{position:fixed; z-index:10; left:50%; transform:translateX(-50%); bottom:var(--padB)}
  .botPanel{position:absolute; left:50%; transform:translate(-50%,-8px); bottom:42px; width:min(96vw,620px); height:var(--edgeH); display:none}
  .dockBottom.open .botPanel{display:block}
  /* LEFT */
  .dockLeft{position:fixed; z-index:10; left:var(--pad); top:50%; transform:translateY(-50%)}
  .leftPanel{position:absolute; left:calc(var(--pad) + 42px); top:50%; transform:translateY(-50%); width:var(--sideW); display:none}
  .dockLeft.open .leftPanel{display:block}
  /* RIGHT */
  .dockRight{position:fixed; z-index:10; right:var(--padR); top:50%; transform:translateY(-50%)}
  .rightPanel{position:absolute; right:calc(var(--padR) + 42px); top:50%; transform:translateY(-50%); width:var(--sideW); display:none}
  .dockRight.open .rightPanel{display:block}
  /* tiny Re button if you want it on this page too */
  .re{
    position:fixed; bottom:6px; left:6px; z-index:20;
    font-size:9px; padding:2px 6px; opacity:.55;
    background:rgba(0,0,0,.55); color:#eafff4;
    border:1px solid var(--glow); border-radius:6px; cursor:pointer;
    touch-action:manipulation;
  }
  .re:hover{opacity:1; box-shadow:0 0 6px var(--glow)}
</style>
</head>
<body>

<canvas id="stage"></canvas>

<!-- TOP: wedges + mix + mode -->
<div class="dockTop" id="dockTop">
  <button class="pill" data-toggle="dockTop" title="Top"></button>
  <div class="mini topPanel">
    <label>Wedges<input id="wedges" type="range" min="2" max="16" step="1" value="8"></label>
    <label>Mix<input id="mix" type="range" min="0" max="1" step="0.001" value="0.5"></label>
    <div style="display:flex; gap:8px; align-items:center">
      <button id="modeK" class="pill" style="padding:6px 10px" title="Kaleidoscope">✳️</button>
      <button id="modeM" class="pill" style="padding:6px 10px" title="Mirror"></button>
    </div>
  </div>
</div>

<!-- BOTTOM: decks + capture -->
<div class="dockBottom" id="dockBottom">
  <button class="pill" data-toggle="dockBottom" title="Bottom"></button>
  <div class="mini botPanel">
    <label>Deck A<input id="pickA" type="file" accept="image/*,video/*"></label>
    <label>Deck B<input id="pickB" type="file" accept="image/*,video/*"></label>
    <button id="snap" class="pill" style="padding:6px 10px" title="Snapshot"></button>
    <button id="rec"  class="pill" style="padding:6px 10px" title="Record">⏺</button>
    <span id="recLamp" style="display:inline-block;width:10px;height:10px;margin-left:8px;border-radius:50%;background:#193b30;vertical-align:middle"></span>
  </div>
</div>

<!-- LEFT: transform -->
<div class="dockLeft" id="dockLeft">
  <button class="pill" data-toggle="dockLeft" title="Left">◀</button>
  <div class="mini leftPanel">
    <label>Zoom<input id="zoom" type="range" min="0.2" max="6" step="0.001" value="1"></label>
    <label>Rotate<input id="rot" type="range" min="-3.1416" max="3.1416" step="0.0005" value="0"></label>
    <label>Pan X<input id="panx" type="range" min="-1" max="1" step="0.0005" value="0"></label>
    <label>Pan Y<input id="pany" type="range" min="-1" max="1" step="0.0005" value="0"></label>
    <label>Spin<input id="spinHz" type="range" min="-0.05" max="0.05" step="0.0001" value="0"></label>
  </div>
</div>

<!-- RIGHT: ripple -->
<div class="dockRight" id="dockRight">
  <button class="pill" data-toggle="dockRight" title="Right">▶</button>
  <div class="mini rightPanel">
    <label>Ripple Amt<input id="rAmp" type="range" min="0" max="0.6" step="0.001" value="0.20"></label>
    <label>Frequency<input id="rFreq" type="range" min="0.5" max="12" step="0.01" value="6"></label>
    <label>Speed<input id="rSpeed" type="range" min="0" max="6" step="0.01" value="1.5"></label>
  </div>
</div>

<!-- optional tiny "Re" -->
<button class="re" onclick="location.reload()">Re</button>

<script>
/* ===== edge panel toggles ===== */
document.querySelectorAll('[data-toggle]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.getAttribute('data-toggle');
    const dock = document.getElementById(id);
    dock.classList.toggle('open');
    document.querySelectorAll('.dockTop,.dockBottom,.dockLeft,.dockRight').forEach(d=>{
      if(d!==dock) d.classList.remove('open');
    });
  }, {passive:true});
});

/* ===== GLOBAL TOUCH LOCK FIXES ===== */
addEventListener('gesturestart', e=> e.preventDefault(), {passive:false}); // iOS pinch
addEventListener('wheel', e=> { if(e.ctrlKey) e.preventDefault(); }, {passive:false}); // ctrl+wheel zoom
function isUI(el){ return el.closest('.mini') || el.closest('.pill') || el.closest('input,button,select,textarea,label'); }
addEventListener('touchmove', e=> { if(!isUI(e.target)) e.preventDefault(); }, {passive:false});
let lastTap=0; addEventListener('touchend', e=> { const now=performance.now(); if(now-lastTap<300) e.preventDefault(); lastTap=now; }, {passive:false});
addEventListener('contextmenu', e=> e.preventDefault(), {passive:false});
addEventListener('selectstart', e=> e.preventDefault(), {passive:false});

/* ===== WebGL Kaleidoscope Engine ===== */
(function(){
  const $ = id=>document.getElementById(id);
  const cv = $('stage');
  const UI = {
    mix:$('mix'), wedges:$('wedges'),
    zoom:$('zoom'), rot:$('rot'), panx:$('panx'), pany:$('pany'), spinHz:$('spinHz'),
    rAmp:$('rAmp'), rFreq:$('rFreq'), rSpeed:$('rSpeed'),
    modeK:$('modeK'), modeM:$('modeM'),
    pickA:$('pickA'), pickB:$('pickB'),
    snap:$('snap'), rec:$('rec'), recLamp:$('recLamp')
  };
  const state = {
    mix:+UI.mix.value, wedges:+UI.wedges.value,
    zoom:+UI.zoom.value, rot:+UI.rot.value, panx:+UI.panx.value, pany:+UI.pany.value, spinHz:+UI.spinHz.value,
    rAmp:+UI.rAmp.value, rFreq:+UI.rFreq.value, rSpeed:+UI.rSpeed.value,
    mode:0
  };
  ['mix','wedges','zoom','rot','panx','pany','spinHz','rAmp','rFreq','rSpeed']
   .forEach(k=> UI[k].addEventListener('input', ()=> state[k]=+UI[k].value, {passive:true}));
  UI.modeK.onclick = ()=> state.mode=0;
  UI.modeM.onclick = ()=> state.mode=1;

  function fit(){
    const dpr=Math.min(devicePixelRatio||1,2);
    const w=Math.floor(innerWidth*dpr), h=Math.floor(innerHeight*dpr);
    if(cv.width!==w||cv.height!==h){ cv.width=w; cv.height=h; }
  }
  addEventListener('resize', fit, {passive:true}); fit();

  const deckA = {img:null, vid:null, cvs:document.createElement('canvas'), ctx:null};
  const deckB = {img:null, vid:null, cvs:document.createElement('canvas'), ctx:null};
  deckA.ctx = deckA.cvs.getContext('2d'); deckB.ctx = deckB.cvs.getContext('2d');

  function loadTo(deck, file){
    if(!file) return;
    if(file.type.startsWith('video')){
      const v=document.createElement('video');
      v.muted=true; v.loop=true; v.playsInline=true; v.autoplay=true;
      v.onloadeddata=()=>{ v.play().catch(()=>{}); deck.vid=v; deck.img=null; };
      v.src=URL.createObjectURL(file);
    }else{
      const img=new Image();
      img.onload=()=>{ deck.img=img; deck.vid=null; };
      img.src=URL.createObjectURL(file);
    }
  }
  UI.pickA.onchange = e=>{ loadTo(deckA, e.target.files[0]); e.target.value=''; };
  UI.pickB.onchange = e=>{ loadTo(deckB, e.target.files[0]); e.target.value=''; };

  function tryGL(ver){ try{ return cv.getContext(ver,{preserveDrawingBuffer:true,antialias:true}); }catch{return null;} }
  const gl = tryGL('webgl2') || tryGL('webgl');
  if(!gl){ alert('WebGL not supported'); return; }

  const vs = `attribute vec2 aPos; varying vec2 vUv;
              void main(){ vUv=(aPos+1.0)*0.5; gl_Position=vec4(aPos,0.,1.); }`;
  const fs = `
    precision highp float; varying vec2 vUv;
    uniform sampler2D texA, texB; uniform float mixAB;
    uniform vec2 resolution; uniform float time;
    uniform int mode; uniform float wedges; uniform float zoom, rot; uniform vec2 pan;
    uniform float rAmp, rFreq, rSpeed; uniform float imgSpin;
    mat2 R(float a){ float c=cos(a), s=sin(a); return mat2(c,-s,s,c); }
    vec2 rotAround(vec2 uv, float a){ vec2 d=uv-0.5; d=R(a)*d; return d+0.5; }
    vec2 userUV(vec2 p){
      vec2 q = R(rot)*p;
      float r = length(q);
      float wave = sin(r*rFreq - time*rSpeed);
      q *= (1.0 + wave * rAmp);
      q *= zoom; q += pan;
      return q*0.5 + 0.5;
    }
    vec3 sampleMix(vec2 uv){
      vec2 suv = rotAround(uv, imgSpin);
      vec4 a=texture2D(texA,suv), b=texture2D(texB,suv);
      return mix(a,b,clamp(mixAB,0.0,1.0)).rgb;
    }
    vec3 kaleido(){
      vec2 n=vUv*2.0-1.0; n.x *= resolution.x/resolution.y;
      float ang=atan(n.y,n.x), r=length(n);
      float sector = 6.28318530718 / max(2.0, wedges);
      float a = mod(ang, sector); if(a>0.5*sector) a = sector - a;
      vec2 dir = vec2(cos(a), sin(a));
      return sampleMix(userUV(r*dir));
    }
    vec3 mirrorFX(){
      vec2 n=vUv*2.0-1.0; n.x *= resolution.x/resolution.y;
      vec2 p = vec2(abs(n.x), n.y);
      return sampleMix(userUV(p));
    }
    void main(){ vec3 col = (mode==0)? kaleido() : mirrorFX(); gl_FragColor = vec4(col,1.0); }
  `;
  function sh(t,s){ const o=gl.createShader(t); gl.shaderSource(o,s); gl.compileShader(o); if(!gl.getShaderParameter(o,gl.COMPILE_STATUS)) throw gl.getShaderInfoLog(o); return o; }
  const pr=gl.createProgram(); gl.attachShader(pr, sh(gl.VERTEX_SHADER,vs)); gl.attachShader(pr, sh(gl.FRAGMENT_SHADER,fs)); gl.linkProgram(pr);
  if(!gl.getProgramParameter(pr,gl.LINK_STATUS)) throw gl.getProgramInfoLog(pr);
  gl.useProgram(pr);

  const quad=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,quad);
  gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1, 1,-1, -1,1, 1,-1, 1,1, -1,1]),gl.STATIC_DRAW);
  const aPos=gl.getAttribLocation(pr,'aPos'); gl.enableVertexAttribArray(aPos); gl.vertexAttribPointer(aPos,2,gl.FLOAT,false,0,0);

  const U={}; ['texA','texB','mixAB','resolution','time','mode','wedges','zoom','rot','pan','rAmp','rFreq','rSpeed','imgSpin'].forEach(n=>U[n]=gl.getUniformLocation(pr,n));

  function mkTex(){ const t=gl.createTexture(); gl.bindTexture(gl.TEXTURE_2D,t);
    gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
    gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
    gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.MIRRORED_REPEAT);
    gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.MIRRORED_REPEAT);
    const c=document.createElement('canvas'); c.width=c.height=32; const x=c.getContext('2d');
    x.fillStyle='#333'; x.fillRect(0,0,32,32); x.fillStyle='#777'; x.fillRect(0,0,16,16);
    gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,c); return t;
  }
  deckA.tex=mkTex(); deckB.tex=mkTex();

  function upload(deck){
    const src=(deck.vid && !deck.vid.paused && !deck.vid.ended)? deck.vid : deck.img; if(!src) return;
    const w=src.videoWidth||src.naturalWidth||src.width, h=src.videoHeight||src.naturalHeight||src.height; if(!w||!h) return;
    deck.cvs.width=w; deck.cvs.height=h; (deck.ctx||=deck.cvs.getContext('2d')).drawImage(src,0,0,w,h);
    gl.bindTexture(gl.TEXTURE_2D, deck.tex); gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,deck.cvs);
  }

  // gestures on canvas
  const clamp=(v,lo,hi)=>Math.min(hi,Math.max(lo,v));
  const pts=new Map(); let base={panx:0,pany:0,zoom:1,rot:0,cX:0,cY:0,dist:0,ang:0};
  function centroid(){ let sx=0,sy=0; for(const p of pts.values()){sx+=p.x; sy+=p.y} const n=pts.size; return {x:sx/n,y:sy/n,n}; }
  function distAng(){ const it=pts.values(); const a=it.next().value, b=it.next().value; const dx=b.x-a.x, dy=b.y-a.y; return {dist:Math.hypot(dx,dy), ang:Math.atan2(dy,dx)}; }
  function snapshotBase(){ base={panx:state.panx,pany:state.pany,zoom:state.zoom,rot:state.rot,cX:0,cY:0,dist:0,ang:0}; if(pts.size>=2){ const c=centroid(); base.cX=c.x;base.cY=c.y; const da=distAng(); base.dist=da.dist;base.ang=da.ang; } }
  function syncUI(){ UI.panx.value=state.panx; UI.pany.value=state.pany; UI.zoom.value=state.zoom; UI.rot.value=state.rot; }
  cv.addEventListener('pointerdown', e=>{ cv.setPointerCapture(e.pointerId); pts.set(e.pointerId,{x:e.clientX,y:e.clientY}); snapshotBase(); }, {passive:false});
  cv.addEventListener('pointermove', e=>{
    if(!pts.has(e.pointerId)) return;
    pts.set(e.pointerId,{x:e.clientX,y:e.clientY});
    const c=centroid();
    if(c.n===1){
      state.panx = clamp(state.panx + (e.movementX/innerWidth)*2, -4, 4);
      state.pany = clamp(state.pany - (e.movementY/innerHeight)*2, -4, 4);
      syncUI();
    } else {
      const {dist,ang}=distAng();
      const scale = base.dist ? (dist/base.dist) : 1;
      state.zoom = clamp(base.zoom * scale, +UI.zoom.min||0.2, +UI.zoom.max||6);
      let dAng=ang-base.ang; if(dAng>Math.PI) dAng-=2*Math.PI; if(dAng<-Math.PI) dAng+=2*Math.PI;
      state.rot = clamp(base.rot + dAng, +UI.rot.min||-Math.PI, +UI.rot.max||Math.PI);
      state.panx = clamp(base.panx + ((c.x-base.cX)/innerWidth)*2, -4, 4);
      state.pany = clamp(base.pany - ((c.y-base.cY)/innerHeight)*2, -4, 4);
      syncUI();
    }
    e.preventDefault();
  }, {passive:false});
  function up(e){ pts.delete(e.pointerId); if(pts.size>0) snapshotBase(); }
  cv.addEventListener('pointerup', up, {passive:false});
  cv.addEventListener('pointercancel', up, {passive:false});
  cv.addEventListener('pointerleave', up, {passive:false});

  // draw loop
  let t0=performance.now();
  function draw(){
    fit(); upload(deckA); upload(deckB);
    gl.useProgram(pr);
    gl.uniform1i(U.texA,0); gl.uniform1i(U.texB,1);
    gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D, deckA.tex);
    gl.activeTexture(gl.TEXTURE1); gl.bindTexture(gl.TEXTURE_2D, deckB.tex);
    gl.uniform2f(U.resolution, cv.width, cv.height);
    const t=(performance.now()-t0)/1000.0;
    gl.uniform1f(U.time,t);
    gl.uniform1i(U.mode,state.mode);
    gl.uniform1f(U.wedges,state.wedges);
    gl.uniform1f(U.zoom,state.zoom);
    gl.uniform1f(U.rot,state.rot);
    gl.uniform2f(U.pan,state.panx,state.pany);
    gl.uniform1f(U.rAmp,state.rAmp);
    gl.uniform1f(U.rFreq,state.rFreq);
    gl.uniform1f(U.rSpeed,state.rSpeed);
    gl.uniform1f(U.imgSpin,state.spinHz*6.28318530718*t);
    gl.uniform1f(U.mixAB,state.mix);
    gl.viewport(0,0,cv.width,cv.height);
    gl.drawArrays(gl.TRIANGLES,0,6);
    requestAnimationFrame(draw);
  }
  draw();

  /* ===== Snapshot ===== */
  UI.snap.addEventListener('click', ()=>{
    try{
      const url=cv.toDataURL('image/png'); const a=document.createElement('a');
      a.href=URL.createObjectURL((()=>{const b64=url.split(',')[1]; const bin=atob(b64); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i); return new Blob([arr],{type:'image/png'});})());
      a.download='kaleidoscope.png'; a.click();
    }catch(e){ alert('Snapshot blocked (CORS on external media).'); }
  });

  /* ===== Robust Record (Start/Stop toggle) — now HIGH RES (12 Mbps) ===== */
  (function(){
    const btn = UI.rec;
    const lamp = UI.recLamp;
    let stream=null, rec=null, chunks=[], recording=false;

    function getStream(){ if(!stream && cv.captureStream) stream=cv.captureStream(60); return stream; }
    function pickType(){
      const types=['video/webm;codecs=vp9','video/webm;codecs=vp8','video/webm','video/mp4;codecs=h264'];
      for(const t of types){ try{ if(MediaRecorder.isTypeSupported(t)) return t; }catch{} }
      return '';
    }
    function start(){
      const s=getStream();
      if(!s) return alert('canvas.captureStream not supported.');
      if(!('MediaRecorder' in window)) return alert('MediaRecorder not supported.');
      chunks=[];
      const mt=pickType();

      /* ←— CHANGED: force high bitrate for crisp output */
      const opts = mt ? { mimeType: mt, videoBitsPerSecond: 12_000_000 }
                      : {                 videoBitsPerSecond: 12_000_000 };

      try{ rec = new MediaRecorder(s, opts); }
      catch(e){ console.error(e); return alert('Recorder could not start (codec).'); }

      rec.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
      rec.onstop = () => {
        const size = chunks.reduce((n,b)=>n+b.size,0);
        if(!size){ lamp.style.background='#193b30'; btn.textContent='⏺'; recording=false; alert('No frames captured—record ~2s before stopping.'); return; }
        const blob = new Blob(chunks,{type:rec.mimeType||'video/webm'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
        a.download = blob.type.includes('mp4') ? 'kaleidoscope.mp4' : 'kaleidoscope.webm';
        a.click(); chunks=[]; lamp.style.background='#193b30'; btn.textContent='⏺'; recording=false;
      };
      rec.start(); // single blob emitted on stop
      recording=true; btn.textContent='⏹'; lamp.style.background='#ff445f';
    }
    function stop(){ try{ if(rec && rec.state!=='inactive') rec.stop(); }catch(e){ console.error(e); } }

    btn.addEventListener('click', ()=> recording ? stop() : start());
  })();

})(); // end engine
</script>
<script>
(function attachOverlay(){
  if (document.readyState !== 'complete' && document.readyState !== 'interactive') {
    document.addEventListener('DOMContentLoaded', attachOverlay, {once:true});
    return;
  }

  const BG_URL = "https://i.imgur.com/Tz3AOMI.jpeg";

  // Overlay container
  const overlay = document.createElement('div');
  overlay.id = '__lw_overlay';
  overlay.style.cssText = 'position:fixed;inset:0;z-index:2147483647;display:grid;place-items:center;font-family:"Luckiest Guy",system-ui,sans-serif;color:white;text-align:center';

  // Background image
  const bg = document.createElement('img');
  bg.src = BG_URL;
  bg.alt = 'background';
  bg.style.cssText = 'position:fixed;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(1.2) contrast(1.1);z-index:0';

  // Card
  const card = document.createElement('div');
  card.style.cssText = 'position:relative;z-index:1;background:rgba(0,0,0,.55);border-radius:18px;padding:24px 32px;max-width:480px;backdrop-filter:blur(12px) saturate(120%);box-shadow:0 16px 60px rgba(0,0,0,.6)';

  // Mission text
  const mission = document.createElement('p');
  mission.textContent = "🌟 Our mission: We create psychedelic art, music, and stories to raise funds that help kids with food, school, and inspiration. Every donation supports this cause. 🌟";
  mission.style.cssText = 'font-size:1rem;line-height:1.4;margin-bottom:18px;color:#f8faff';

  // Donation buttons
  const donateBox = document.createElement('div');
  donateBox.style.cssText = 'display:flex;justify-content:center;gap:14px;margin-bottom:18px';

  const cash = document.createElement('a');
  cash.href = "https://cash.app/$lightwell333";
  cash.target = "_blank";
  cash.textContent = "💚 Cash App";
  cash.style.cssText = 'background:#00c244;color:white;text-decoration:none;font-weight:700;padding:.6em 1.2em;border-radius:8px';

  const paypal = document.createElement('a');
  paypal.href = "https://paypal.me/lightwell333";
  paypal.target = "_blank";
  paypal.textContent = "💙 PayPal";
  paypal.style.cssText = 'background:#0070ba;color:white;text-decoration:none;font-weight:700;padding:.6em 1.2em;border-radius:8px';

  donateBox.appendChild(cash);
  donateBox.appendChild(paypal);

  // Enter button
  const enter = document.createElement('button');
  enter.textContent = "ENTER";
  enter.style.cssText = 'appearance:none;border:0;cursor:pointer;font-weight:900;letter-spacing:.6px;font-size:22px;padding:.8em 2em;border-radius:999px;color:#031b1a;background:linear-gradient(45deg,#ff00ff,#00ffff,#ff9900,#7dffb3);background-size:300% 300%;box-shadow:0 12px 32px rgba(0,0,0,.45),0 0 0 3px rgba(255,255,255,.15) inset';

  // Assemble
  card.appendChild(mission);
  card.appendChild(donateBox);
  card.appendChild(enter);
  overlay.appendChild(bg);
  overlay.appendChild(card);
  document.body.appendChild(overlay);

  // Re button (tiny, bottom-left)
  const re = document.createElement('button');
  re.textContent = 're';
  re.title = 'Reappear overlay';
  re.style.cssText = 'position:fixed;left:10px;bottom:10px;z-index:2147483647;font-size:12px;padding:4px 8px;border-radius:7px;background:rgba(0,0,0,.55);color:#dffcff;border:1px solid rgba(255,255,255,.65);cursor:pointer;opacity:.7';
  re.onmouseenter = () => re.style.opacity = '1';
  re.onmouseleave = () => re.style.opacity = '.7';
  document.body.appendChild(re);

  // Manage canvases so they don't block overlay clicks
  const canvases = Array.from(document.querySelectorAll('canvas'));
  function disableCanvases(){ canvases.forEach(c => { c.dataset.__pe = c.style.pointerEvents || ''; c.style.pointerEvents = 'none'; }); }
  function restoreCanvases(){ canvases.forEach(c => { c.style.pointerEvents = c.dataset.__pe; delete c.dataset.__pe; }); }
  disableCanvases();

  // Button behavior
  enter.addEventListener('click', () => {
    overlay.style.display = 'none';
    restoreCanvases();
  });
  re.addEventListener('click', () => {
    overlay.style.display = 'grid';
    disableCanvases();
  });
})();
</script>
<!-- === Epic Mixer Deck Overlay — REAL WAVEFORMS + TOUCH SCRUB === -->
<style>
  :root { --fg:#eafff4; --line:#23313f; --glow:#00ff66; --muted:#9fd0c0; }
  /* Pill */
  #mix-pill{
    position:fixed; top:12px; left:12px; z-index:2147483647;
    background:#001a0d; color:var(--fg); border:1px solid var(--line);
    border-radius:999px; padding:10px 14px; font-size:18px; cursor:pointer;
    box-shadow:0 0 10px var(--glow),0 0 22px var(--glow);
  }
  /* Panel */
  #mix-panel{
    position:fixed; inset:0; z-index:2147483646; display:none; overflow:auto;
    background:rgba(0,0,0,.8); backdrop-filter:blur(10px);
    padding:clamp(10px,2vw,18px);
  }
  #mix-panel.open{ display:block; }

  .deck,.master{
    background:rgba(15,20,18,.85); border:1px solid var(--line);
    border-radius:12px; padding:12px; margin-bottom:14px;
    box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
  }
  h2{margin:0 0 8px 0; font-size:18px; font-weight:800}
  .ctrls{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .knob{display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted)}
  .knob input[type=range]{width:140px}
  .time{font-variant-numeric:tabular-nums; font-size:12px; color:var(--muted)}

  /* Waveforms */
  .wave{
    position:relative; height:120px; background:#0c1117;
    border:1px solid #182233; border-radius:8px; overflow:hidden;
    margin:8px 0; touch-action:none;
  }
  .wave canvas{width:100%; height:100%; display:block}
  .grid{position:absolute; inset:0; pointer-events:none}
  .playhead{position:absolute; top:0; bottom:0; width:2px; background:#fff}
  .cue{position:absolute; top:0; bottom:0; width:2px; background:#ffdf7a; display:none}
  .scrub{position:absolute; top:0; bottom:0; width:1px; background:#00ff66; opacity:.95; pointer-events:none; display:none}

  /* Master */
  .xfade{display:flex; align-items:center; gap:10px; margin:10px 0}
  .xfade input{flex:1}
  .meters{display:flex; gap:6px; align-items:flex-end}
  .meter{width:12px; height:60px; background:#0c1117; border:1px solid #182233; border-radius:4px; overflow:hidden}
  .bar{width:100%; height:0; background:linear-gradient(#a8ffbf,#00ff66)}

  /* Neon-green buttons */
  .btn{
    background:#00ff66; color:#001a0d; font-weight:800; border:none;
    padding:.55rem 1.1rem; border-radius:10px; font-size:15px; cursor:pointer;
    box-shadow:0 0 10px #00ff66,0 0 22px #00ff66; text-shadow:0 0 4px #00ff66;
    transition:transform .15s, box-shadow .2s;
  }
  .btn:hover{ transform:translateY(-1px) scale(1.03); box-shadow:0 0 20px #00ff66,0 0 44px #00ff66; }
  .btn:active{ transform:translateY(0) scale(.97); box-shadow:0 0 8px #00ff66,0 0 16px #00ff66; }
  .btn:disabled{opacity:.55; cursor:not-allowed}
</style>

<button id="mix-pill">🎛</button>

<div id="mix-panel">
  <!-- Deck A -->
  <div class="deck" id="deckA">
    <h2>Deck A <input id="fileA" type="file" accept="audio/*"></h2>
    <div class="wave" id="wrapA">
      <canvas id="waveA"></canvas>
      <canvas class="grid" id="gridA"></canvas>
      <div class="playhead" id="playA"></div>
      <div class="cue" id="cueA"></div>
      <div class="scrub" id="scrubA"></div>
    </div>
    <div class="ctrls">
      <button class="btn" id="playPauseA">▶️ Play</button>
      <button class="btn" id="stopA">⏹ Stop</button>
      <button class="btn" id="backA">⏪ -5s</button>
      <button class="btn" id="fwdA">⏩ +5s</button>
      <button class="btn" id="setCueA">🎯 Set Cue</button>
      <button class="btn" id="gotoCueA">↩️ Cue</button>
      <span class="time" id="timeA">00:00 / 00:00</span>
      <span class="knob">Vol <input id="volA" type="range" min="0" max="1" step="0.01" value="1"></span>
      <span class="knob">Rate <input id="rateA" type="range" min="0.5" max="1.5" step="0.01" value="1"></span>
    </div>
  </div>

  <!-- Deck B -->
  <div class="deck" id="deckB">
    <h2>Deck B <input id="fileB" type="file" accept="audio/*"></h2>
    <div class="wave" id="wrapB">
      <canvas id="waveB"></canvas>
      <canvas class="grid" id="gridB"></canvas>
      <div class="playhead" id="playB"></div>
      <div class="cue" id="cueB"></div>
      <div class="scrub" id="scrubB"></div>
    </div>
    <div class="ctrls">
      <button class="btn" id="playPauseB">▶️ Play</button>
      <button class="btn" id="stopB">⏹ Stop</button>
      <button class="btn" id="backB">⏪ -5s</button>
      <button class="btn" id="fwdB">⏩ +5s</button>
      <button class="btn" id="setCueB">🎯 Set Cue</button>
      <button class="btn" id="gotoCueB">↩️ Cue</button>
      <span class="time" id="timeB">00:00 / 00:00</span>
      <span class="knob">Vol <input id="volB" type="range" min="0" max="1" step="0.01" value="1"></span>
      <span class="knob">Rate <input id="rateB" type="range" min="0.5" max="1.5" step="0.01" value="1"></span>
    </div>
  </div>

  <!-- Master -->
  <div class="master">
    <div class="xfade">
      <strong>Crossfader</strong>
      <input id="xfader" type="range" min="0" max="1" step="0.001" value="0.5">
    </div>
    <div class="meters">
      <div class="meter"><div class="bar" id="meterL"></div></div>
      <div class="meter"><div class="bar" id="meterR"></div></div>
    </div>
    <div class="ctrls">
      <button class="btn" id="recStart">● Record</button>
      <button class="btn" id="recStop" disabled>■ Stop</button>
      <button class="btn" id="hideMix">Close</button>
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== Show/Hide Panel ===== */
  const panel = document.getElementById('mix-panel');
  document.getElementById('mix-pill').addEventListener('click', ()=> panel.classList.toggle('open'));
  document.getElementById('hideMix').addEventListener('click', ()=> panel.classList.remove('open'));

  /* ===== Audio Graph ===== */
  const AC = new (window.AudioContext||window.webkitAudioContext)();
  const master = AC.createGain(); master.connect(AC.destination);
  const dest   = AC.createMediaStreamDestination(); master.connect(dest);
  const analyser = AC.createAnalyser(); analyser.fftSize=2048; master.connect(analyser);
  const meterData = new Uint8Array(analyser.frequencyBinCount);

  const fmt = s => { s|=0; const m=(s/60)|0, ss=(s%60)|0; return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; };

  class Deck {
    constructor(tag){
      this.tag = tag; // 'A' or 'B'
      // Elements
      this.el = {
        file: document.getElementById('file'+tag),
        playPause: document.getElementById('playPause'+tag),
        stop: document.getElementById('stop'+tag),
        back: document.getElementById('back'+tag),
        fwd: document.getElementById('fwd'+tag),
        setCue: document.getElementById('setCue'+tag),
        gotoCue: document.getElementById('gotoCue'+tag),
        vol: document.getElementById('vol'+tag),
        rate: document.getElementById('rate'+tag),
        time: document.getElementById('time'+tag),
        wrap: document.getElementById('wrap'+tag),
        wave: document.getElementById('wave'+tag),
        grid: document.getElementById('grid'+tag),
        playhead: document.getElementById('play'+tag),
        cue: document.getElementById('cue'+tag),
        scrub: document.getElementById('scrub'+tag),
      };

      // Audio nodes
      this.audio = new Audio(); this.audio.crossOrigin='anonymous'; this.audio.preload='metadata';
      this.src = AC.createMediaElementSource(this.audio);
      this.gain = AC.createGain(); this.gain.gain.value = 1;
      this.pan = AC.createStereoPanner(); this.pan.pan.value = 0;
      this.src.connect(this.gain).connect(this.pan).connect(master);

      // Waveform drawing
      this.ctx = this.el.wave.getContext('2d');
      this.peaks = null; // computed min/max array
      this.buffer = null;
      this.cueTime = null;

      // Bind UI
      this.el.file.addEventListener('change', e=> this.loadFile(e.target.files[0]));
      this.el.playPause.addEventListener('click', ()=> this.toggle());
      this.el.stop.addEventListener('click', ()=> { this.audio.pause(); this.audio.currentTime=0; this.el.playPause.textContent='▶️ Play'; this.updateUI(); });
      this.el.back.addEventListener('click', ()=> this.jump(-5));
      this.el.fwd.addEventListener('click',  ()=> this.jump(+5));
      this.el.vol.addEventListener('input', ()=> this.gain.gain.value = +this.el.vol.value);
      this.el.rate.addEventListener('input',()=> this.audio.playbackRate = +this.el.rate.value);
      this.el.setCue.addEventListener('click',()=> { this.cueTime = this.audio.currentTime; this.el.cue.style.display='block'; this.updateUI(); });
      this.el.gotoCue.addEventListener('click',()=> { if(this.cueTime!=null) this.audio.currentTime = this.cueTime; });

      this.audio.addEventListener('timeupdate', ()=> this.updateUI());
      this.audio.addEventListener('loadedmetadata', ()=> this.updateUI());

      new ResizeObserver(()=> this.redrawAll()).observe(this.el.wrap);
      this.attachScrub();
    }

    connectTo(node){ this.gain.disconnect(); this.gain.connect(node); }

    async loadFile(file){
      if(!file) return;
      // Set src for playback
      this.audio.src = URL.createObjectURL(file);
      this.audio.playbackRate = +this.el.rate.value;

      // Decode for waveform
      try{
        const arr = await file.arrayBuffer();
        this.buffer = await AC.decodeAudioData(arr.slice(0)); // Safari-safe copy
        this.peaks = this.computePeaks(this.buffer, Math.max(300, this.el.wrap.clientWidth * (devicePixelRatio||1)));
        this.redrawAll();
      }catch(err){ console.error('decode error', err); this.buffer=null; this.peaks=null; this.redrawAll(); }
      // enable controls
      ['playPause','stop','back','fwd','setCue','gotoCue'].forEach(id => this.el[id].disabled=false);
    }

    computePeaks(buffer, width){
      const ch = buffer.getChannelData(0);
      const block = Math.ceil(ch.length / width);
      const peaks = new Float32Array(width*2); // min/max pairs
      for(let i=0;i<width;i++){
        let start = i*block, end = Math.min((i+1)*block, ch.length);
        let min=1e9, max=-1e9;
        for(let j=start;j<end;j++){ const v=ch[j]; if(v<min) min=v; if(v>max) max=v; }
        peaks[i*2] = min; peaks[i*2+1] = max;
      }
      return peaks;
    }

    drawGrid(){
      const g = this.el.grid, ctx = g.getContext('2d');
      const dpr = Math.min(devicePixelRatio||1, 2);
      const W = Math.floor(this.el.wrap.clientWidth * dpr);
      const H = Math.floor(this.el.wrap.clientHeight * dpr);
      g.width=W; g.height=H;
      ctx.clearRect(0,0,W,H);
      ctx.globalAlpha = .12; ctx.strokeStyle = '#d6ffe8'; ctx.lineWidth = Math.max(1,dpr);
      const step = 80 * dpr;
      for(let x=0;x<W;x+=step){ ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,H); ctx.stroke(); }
      ctx.globalAlpha = .2; ctx.beginPath(); ctx.moveTo(0,H/2); ctx.lineTo(W,H/2); ctx.stroke();
    }

    drawWaveform(){
      const dpr = Math.min(devicePixelRatio||1, 2);
      const W = Math.floor(this.el.wrap.clientWidth * dpr);
      const H = Math.floor(this.el.wrap.clientHeight * dpr);
      const cvs = this.el.wave; cvs.width=W; cvs.height=H;
      const ctx = this.ctx;
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle='#0c1117'; ctx.fillRect(0,0,W,H);

      if(!this.peaks){
        // placeholder ticks
        ctx.fillStyle='rgba(255,255,255,.08)'; for(let i=0;i<W;i+=8*dpr) ctx.fillRect(i,0,1,H);
        return;
      }
      const amp = H/2;
      ctx.strokeStyle = '#00ff66';
      ctx.lineWidth = Math.max(1, dpr);
      ctx.beginPath();
      for(let i=0;i<W;i++){
        const min = this.peaks[i*2], max = this.peaks[i*2+1];
        ctx.moveTo(i, (1+min)*amp);
        ctx.lineTo(i, (1+max)*amp);
      }
      ctx.stroke();

      // midline
      ctx.strokeStyle='rgba(255,255,255,.15)'; ctx.beginPath(); ctx.moveTo(0,amp); ctx.lineTo(W,amp); ctx.stroke();
    }

    redrawAll(){ this.drawGrid(); this.drawWaveform(); this.updateUI(); }

    updateUI(){
      const cur = this.audio.currentTime||0, dur = this.audio.duration||0;
      this.el.time.textContent = `${fmt(cur)} / ${isFinite(dur)?fmt(dur):'00:00'}`;
      const pct = dur? (cur/dur) : 0;
      const w = this.el.wrap.clientWidth;
      this.el.playhead.style.left = ((pct*w)|0)+'px';
      if(this.cueTime!=null && isFinite(dur) && dur>0){
        const q = Math.min(1, Math.max(0, this.cueTime/dur));
        this.el.cue.style.left = ((q*w)|0)+'px';
      }
    }

    jump(dt){ const d=this.audio.duration||0; this.audio.currentTime=Math.min(d,Math.max(0,this.audio.currentTime+dt)); }

    attachScrub(){
      const wrap = this.el.wrap, scrub = this.el.scrub;
      let down=false;

      const posTo = (clientX) => {
        const r = wrap.getBoundingClientRect();
        const x = Math.max(0, Math.min(clientX - r.left, r.width));
        const d = this.audio.duration||0;
        const t = d ? (x/r.width)*d : 0;
        return {x, t};
      };

      const show = x => { scrub.style.display='block'; scrub.style.left=(x|0)+'px'; };
      const hide = () => { scrub.style.display='none'; };

      const start = x => { down=true; const p=posTo(x); this.audio.currentTime=p.t; show(p.x); this.updateUI(); };
      const move  = x => { if(!down) return; const p=posTo(x); this.audio.currentTime=p.t; show(p.x); this.updateUI(); };
      const end   = () => { down=false; hide(); };

      // Mouse
      wrap.addEventListener('mousedown', e=> start(e.clientX));
      window.addEventListener('mousemove', e=> move(e.clientX));
      window.addEventListener('mouseup', end);

      // Touch
      wrap.addEventListener('touchstart', e=>{ start(e.touches[0].clientX); e.preventDefault(); }, {passive:false});
      window.addEventListener('touchmove', e=>{ if(!down) return; move(e.touches[0].clientX); e.preventDefault(); }, {passive:false});
      window.addEventListener('touchend', end);
      window.addEventListener('touchcancel', end);
    }

    toggle(){
      if(this.audio.paused){ this.audio.play().catch(()=>{}); this.el.playPause.textContent='⏸ Pause'; }
      else { this.audio.pause(); this.el.playPause.textContent='▶️ Play'; }
    }
  }

  // Build decks
  const deckA = new Deck('A');
  const deckB = new Deck('B');

  // Route to master via crossfader gains
  const mixA = AC.createGain(), mixB = AC.createGain();
  deckA.connectTo(mixA); deckB.connectTo(mixB);
  mixA.connect(master); mixB.connect(master);

  // Crossfader (equal-power curve)
  const xf = document.getElementById('xfader');
  const setXF = () => {
    const x = +xf.value;
    mixA.gain.value = Math.cos(x*Math.PI/2);
    mixB.gain.value = Math.cos((1-x)*Math.PI/2);
  };
  xf.addEventListener('input', setXF); setXF();

  // VU meters
  const L = document.getElementById('meterL'), R = document.getElementById('meterR');
  function tickMeters(){
    analyser.getByteTimeDomainData(meterData);
    let peak=0; for(let i=0;i<meterData.length;i++){ const v=(meterData[i]-128)/128; peak=Math.max(peak,Math.abs(v)); }
    const h = Math.min(100, Math.floor(peak*160));
    L.style.height = h+'%'; R.style.height = h+'%';
    requestAnimationFrame(tickMeters);
  }
  requestAnimationFrame(tickMeters);

  // Recorder (master mix)
  let rec=null, chunks=[];
  const recStart = document.getElementById('recStart');
  const recStop  = document.getElementById('recStop');
  recStart.addEventListener('click', ()=>{
    chunks=[];
    const types=['audio/webm;codecs=opus','audio/webm'];
    const mime = types.find(t => MediaRecorder.isTypeSupported?.(t)) || '';
    try{
      rec = new MediaRecorder(dest.stream, mime?{mimeType:mime, audioBitsPerSecond:192000}:{});
    }catch(e){ alert('Recorder unsupported in this browser'); return; }
    rec.ondataavailable = e => { if(e.data?.size) chunks.push(e.data); };
    rec.onstop = ()=>{
      if(!chunks.length){ return; }
      const blob = new Blob(chunks, {type: rec.mimeType || 'audio/webm'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = 'mix.webm'; a.click();
    };
    rec.start(); recStart.disabled=true; recStop.disabled=false;
    if(AC.state!=='running') AC.resume();
  });
  recStop.addEventListener('click', ()=>{ try{rec?.stop();}catch{} recStart.disabled=false; recStop.disabled=true; });

  // Mobile unlock
  window.addEventListener('click', ()=>{ if(AC.state!=='running') AC.resume(); }, {once:true, passive:true});
})();
</script>
<!-- === end mixer overlay === -->
</body>
</html>
